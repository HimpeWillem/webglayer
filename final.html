<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Modify Feature</title>

<style type="text/css">
html,body {
	margin: 0;
	padding: 0;
	height: 100%;
	font-family: Verdana, Arial, sans-serif;
}
div.olMapViewport {
	 top: 0;
	 position: relative;
     z-index: 0;     
}


#view {
	position: relative;
}

#map {
	 top: 0;
	margin-right: 32em;
	padding: 0;
	height:100%;	
}

#right {
	position: fixed;
	overflow-y:auto;
	overflow-x:hidden;		
	right: 0;
	top: 0;
	width: 32em;
	height: 100%;
	font-size: 1em;
	moz-box-shadow: 0px 0px 10px black;
	webkit-box-shadow: 0px 0px 9px black;
	box-shadow: -1px 0px 6px black;
	z-index: 10000;
}

#controls {
	position: fixed;
	top: 0em;
	left: 3em;
	width: 512px;
}

#controlToggle {
	padding-left: 1em;
}

#controlToggle li {
	list-style: none;
}

#test {
	top: 0;
	opacity: 1;
	z-index: 1000;
	pointer-events: none;
	position: absolute;
	top: 0px;
}

#chart_container {
	position: absolute;
	top: 0px;
	right: 0px;
}
.chart rect {
  fill: steelblue;
}

.chart text {
  fill: white;
  font: 10px sans-serif;
  text-anchor: end;
}


.selected.bar {
fill: #ff8c00;
}

.unselected.bar {
fill: #7b6888;
}

.out.bar {
fill: #98abc5;
}

.axis text {
  font: 10px sans-serif;
}
.l text {
  font: 10px sans-serif;
}


.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.l {
 cursor: pointer;
 stroke: #000; 
}
.grid-background {
  fill: #ddd;
}

.grid line,
.grid path {
  fill: none;
  stroke: #fff;
  shape-rendering: crispEdges;
}


.brush .extent {
  
  fill-opacity: .125;
  shape-rendering: crispEdges;
}
</style>
<script src="../javascripts/ol/lib/OpenLayers.js"></script>
<script src="../javascripts/jquery-1.9.1.min.js"></script>
<script src="../javascripts/poly2tri.js"></script>
<script src="../javascripts/d3.js"></script>


<script src="map.js"></script>
<script src="gl.js"></script>

<script src="js/Dimension.js"></script>
<script src="js/Manager.js"></script>
<script src="js/OneDDimension.js"></script>
<script src="js/MapDimension.js"></script>
<script src="js/HistogramDimension.js"></script>

<script src="js/MapFilterRender.js"></script>
<script src="js/HistFilterRender.js"></script>
<script src="js/Filter.js"></script>

<script src="js/MapController.js"></script>
<script src="js/DataLoader.js"></script>
<script src="js/Utils.js"></script>
<script src="js/StackedBarChart.js"></script>
<script src="js/BarChart.js"></script>
<script src="js/FloatRasterReader.js"></script>
<script src="js/d3.svg.multibrush.js"></script>


<script type="text/javascript">
    var datafile ="1000000_r.js";
	var map, vectors, controls;

	files = ["10000_r.js","20000_r.js", "50000_r.js","100000_r.js","osm200k.js","500000_r.js","750000_r.js","1000000_r.js"];
	function init() {
		//createChart();
			metadata = [];
		/* New stacked chart */
		
		//chart.update([1, 1, 1, 1,1,1,1,1,1, 1,1, 1, 1, 1,1,1,1,1,1, 1,1, 1, 1, 1,1,1,1,1,1, 1,1, 1, 1, 1,1,1,1,1,1, 10000]);
		
		/* Old chart */
	//	chart = new Chart([1, 1, 1, 1,1,1,1,1,1, 1,1, 1, 1, 1,1,1,1,1,1, 1,1, 1, 1, 1,1,1,1,1,1, 1,1, 1, 1, 1,1,1,1,1,1, 50000]);
		initMap();
		getShader();
		utils = new Utils();
		//r_count = 1 * Math.pow(10, 5);
		manager = new Manager("test");
		mcontroller = new MapController(manager);

		canvas.setAttribute("width", div.offsetWidth);
		canvas.setAttribute("height", div.offsetHeight);

		wgs = new OpenLayers.Projection("EPSG:4326"); // Transform from WGS 1984
		merc = new OpenLayers.Projection("EPSG:900913");
		
		tlwgs = (new OpenLayers.LonLat(-180, 90)).transform(wgs, merc);	
		tl = getTopLeftTC();
		
		
		/*Configure speed dimension*/
		metadata[0] = {max : 180, num_bins : 180, name: "speed"};		
		/*Configure hour dimension*/	
		metadata[1] = {max : 24, num_bins :24 , name: "hours"};
		
		metadata.max_bins =metadata[0].num_bins;
		
		charts = [];
		charts[0] = new StackedBarChart(metadata[0].max, 0, "speed_chart");
		charts[1] = new StackedBarChart(24, 1, "hour_chart");
		
		var data = new DataLoader('../data/'+datafile);
		var rastersize = data.loadData();
		manager.num_rec = data.num_rec;
		/**init geo buffer*/
		manager.addDataBuffer(data.points, 2, 'wPoint');
		/*init first attribute buffer*/				
		for (var i = 0 ; i < metadata.length; i++){
			manager.addDataBuffer(data.attributes[i], 1, metadata[i].name);
		}
				
		/* init index buffer*/
		manager.addDataBuffer(data.index, 2, 'index');
		
		
		dimMap = new MapDimension(manager);
		dimMap.name = "map";
		dimMap.setProgram('map_vShader', 'map_fShader', 'map');

	/*	dimSpeed = new OneDDimension(manager, 3, 180, "speed");
		dimSpeed.setProgram('speed_vShader', 'speed_fShader', 'speed');*/

		
	  	histDim = new HistogramDimension(manager);
	
		mapFilterRender =  new MapFilterRender(manager);
		histFilterRender = new HistFilterRender(manager);
		
		allDataFilter = new Filter(data.num_rec, rastersize, manager); 
		data = null;
		mcontroller.resize(div.offsetWidth, div.offsetHeight);
		mcontroller.zoommove(map.zoom, tl);

		mapFilterRender.init();
		histFilterRender.init();
		//util.createFilteringData(generateOneTriangle());

		fpsElement = document.getElementById("fps");
		then = Date.now() / 1000; // get time in seconds
		request = false;
		var datael = $("#data");
		$("#stop").click(function() {
			if (!request) {
				start();
			} else {
				stop();
			}
		});

		map.events.register("move", map, onMove);
		map.events.register("zoomstart", map, onMove);
		start();

	}

	function initGLDimensions(){
		manager.update();
		mcontroller = new MapController(manager);

		canvas.setAttribute("width", div.offsetWidth);
		canvas.setAttribute("height", div.offsetHeight);
		
		dimMap = new MapDimension(manager);
		dimMap.name = "map";
		dimMap.setProgram('map_vShader', 'map_fShader', 'map');

	/*	dimSpeed = new OneDDimension(manager, 3, 180, "speed");
		dimSpeed.setProgram('speed_vShader', 'speed_fShader', 'speed');*/

		
	  	histDim = new HistogramDimension(manager);
	
		mapFilterRender =  new MapFilterRender(manager);
		histFilterRender = new HistFilterRender(manager);
			
		mcontroller.resize(div.offsetWidth, div.offsetHeight);
		mcontroller.zoommove(map.zoom, tl);

		mapFilterRender.init();
		histFilterRender.init();
	}
	
	onMove = function() {
		mcontroller.zoommove(map.getZoom(), getTopLeftTC());
	}

	generateOneTriangle = function() {
		atr = new Float32Array([ 10, 51, 18, 51, 15, 45 ]);
		return atr;
	}

	getShader = function() {
		$.ajaxSetup({
			async : false
		});

		$.get('shaders/shaders_filtermap.txt', function(data) {
			$("head").append(data);
		});
		
		$.get('shaders/shaders_filterhist.txt', function(data) {
			$("head").append(data);
		});
		
		$.get('shaders/shaders_filter.txt', function(data) {
			$("head").append(data);
		});

		$.get('shaders/shaders_map.txt', function(data) {
			$("head").append(data);
		});
		
		$.get('shaders/shaders_float.txt', function(data) {
			$("head").append(data);
		});

		
		$.get('shaders/shaders_hist.txt', function(data) {
			$("head").append(data);
		});

		$.ajaxSetup({
			async : true
		});

	}
	

	
	

	/** Rendering loop**/

	window.requestAnimFrame = (function() {
		return window.requestAnimationFrame || window.webkitRequestAnimationFrame
				|| window.mozRequestAnimationFrame || function(callback) {
					window.setTimeout(callback, 1000 / 60);
				};
	})();
	
	
	
	function startLoop() {
		num_test =0;
		if (!request) {
			loop();
			//dataupdateloop();
		}
	}

	function stop() {
		if (request) {
			window.cancelAnimationFrame(request);
			request = undefined;
		}
	}
	
	var fps_loop=1;
	var fps_sum=0;

	
	var num_test =0;

	function loop() {
	
		testRender();
		
		if (num_test < 100){
			
		window.requestAnimFrame(loop);
		num_test++;
		};
	};
		
	var sum_time = 0;
	var loop_num = 0;
	function testRender(){
		var start = performance.now();
		
		mcontroller.zoommove(10+Math.random()*2,{x: 138.46093750000057, y: 86.2109375000000+Math.random()*2});		
		
		/*hist filter*/
		histFilterRender.createFilteringData(0, [ -0.5, -0.5, -0.4, -0.5]);
		histFilterRender.createFilteringData(1, [ -1.0, 0.5, 0., 0.5]);			
		histFilterRender.renderFilter();
		
		/*mapfilter*/
		var triangles = new Float32Array([126.875, 108, 139.375, 86.25, 164.375, 106.5, 164.375, 106.5, 139.375, 86.25, 138.875, 74.75]);
		mapFilterRender.createFilteringData(triangles);
		mapFilterRender.renderFilter();
		
		allDataFilter.mapFilter = mapFilterRender.filterTexture;
		allDataFilter.histFilter = histFilterRender.filterTexture;
		allDataFilter.render();
		manager.filterTexture = allDataFilter.filterTexture;

		dimMap.render(manager.num_rec);	
		histDim.render();
		read();
		/**
		END
		*/
		end = performance.now();
		sum_time = sum_time + (end-start);
		loop_num++;
		console.log(end-start);
		console.log("average: "+sum_time/loop_num);
	}
	function runBenchmark(){
		for (var fn = 0; fn <files.length;fn++){
					
		datafile = files[fn];
		sumUpdate = 0;
		loopUpdate = 1;
		canvas = null;
		div = null;
		gl = null;
		init();
		var zoom = 0;

	
		for (var i=0;i<200;i++){
			histFilterRender.createFilteringData(0, [ -0.6321839094161987,
				                                         -0.5,
				                                          -0.40229883790016174,
				                                          -0.5]);
			histFilterRender.createFilteringData(1, [ -0.6321839094161987,
					                                         0.5,
					                                          -0.40229883790016174,
					                                          0.5]);
			var triangles = new Float32Array([126.875, 108, 139.375, 86.25, 164.375, 106.5, 164.375, 106.5, 139.375, 86.25, 138.875, 74.75]);
			mapFilterRender.createFilteringData(triangles);
			mcontroller.zoommove(8+Math.random()*2,{x: 136.46093750000057, y: 86.2109375000000+Math.random()*2});
			
				/**
			* STARTING
			*/
			var start = performance.now();
				
			mapFilterRender.renderFilter();
			allDataFilter.mapFilter = mapFilterRender.filterTexture;
			allDataFilter.histFilter = histFilterRender.filterTexture;
			allDataFilter.render();
			manager.filterTexture = allDataFilter.filterTexture;
	
			dimMap.render(manager.num_rec);	
	
			/**
			END
			*/
			var end = performance.now();

			sumUpdate = sumUpdate + (end - start);
			updateFilterTime = (sumUpdate /loopUpdate);
			//console.log(updateFilterTime);
			loopUpdate++;
			
			gl.flush();
			/**
			* END
			*/
			
			
		}
	
		console.log(datafile +" "+updateFilterTime);
		
		}
	}

</script>
</head>
<body onload="init()">

	<div id="map">
			<canvas id="test">Your browser does not support HTML5</canvas>
	</div>
 <div id="stop" onclick="startLoop()">start/stop</div>
	<div id="right">
		
		
		
			<div id = "speed_chart"></div>
	 		<div id = "hour_chart"></div> 
		
		
		<div> <div id="fps"></div></div>	
		
	</div>
	<div id="controls">
		<ul id="controlToggle">

			<input type="radio" name="type" value="polygon" id="polygonToggle"
				onclick="toggleControl(this);" />
				<label for="polygonToggle">sketch polygon</label>
			
			<input type="radio" name="type" value="modify" id="createVertices"
				onclick="toggleControl(this);" />
				<label for="createVertices">modify polygon</label>
				
			
			
		<!--	<input type="radio" name="type" value="drag" id="dragEvent"
				onclick="toggleControl(this);" />
			<label for="dragEvent">drag polygon</label>
				</li>

			<li><input type="radio" name="type" value="modify"
				id="modifyToggle" onclick="toggleControl(this);" /> <label
				for="modifyToggle">modify feature</label>
				<ul>
					<li><input id="createVertices" type="checkbox" checked
						name="createVertices" onchange="update()" /> <label
						for="createVertices">allow vertices creation</label></li>
			 	<li><input id="rotate" type="checkbox" name="rotate"
						onchange="update()" /> <label for="rotate">allow rotation</label>
					</li>
					<li><input id="resize" type="checkbox" name="resize"
						onchange="update()" /> <label for="resize">allow resizing</label>
						(<input id="keepAspectRatio" type="checkbox"
						name="keepAspectRatio" onchange="update()" checked="checked" /> <label
						for="keepAspectRatio">keep aspect ratio</label>)</li>
					<li><input id="drag" type="checkbox" name="drag"
						onchange="update()" /> <label for="drag">allow dragging</label></li> 
					<li><input id="dragEvent" type="checkbox" name="dragEvent"
						onchange="update()" /> <label for="dragEvent">allow
							dragging Event</label></li>
				</ul></li>-->
		</ul>
		
		
	</div>
</body>
</html>
