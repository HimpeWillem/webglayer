/*! flanders 2016-12-20 */
function DataLoader(){function a(a,b){return"undefined"==typeof b&&(b=[],b.min=Number.MAX_VALUE,b.max=Number.MIN_VALUE),a<b.min&&(b.min=a),a>b.max&&(b.max=a),b}$("#speed_chart").text("Please wait... data are being loaded. This may take a while."),this.loadPosData=function(b){var c=[],d=[],e=[],f=[],g=[],h=[],i=[],j=[],k=new Array(7);k[0]="Sun",k[1]="Mon",k[2]="Tue",k[3]="Wed",k[4]="Thu",k[5]="Fri",k[6]="Sat";var l=new Array(4);l[0]="Stoffelijke schade",l[1]="Gewonden",l[2]="Doden",l[3]="Doden en gewonden";var m=new Array(8);m[0]="Normaal",m[1]="Regenval",m[2]="Mist",m[3]="Sterke wind",m[4]="Sneeuwval",m[5]="Hagelbui",m[6]="Andere",m[7]="Onbekend";var n=new Array(6);n[0]="Droog",n[1]="Nat",n[2]="Ijzel",n[3]="Proper",n[4]="Vuil",n[5]="Onbekend";var o=0;d3.csv(b,function(b,p){var q;p.forEach(function(b,p){c[o++]=parseFloat(b.x),c[o++]=parseFloat(b.y);var r=new Date(1e3*parseInt(b.timestamp));d[p]=k[r.getDay()],e[p]=r.getHours()+r.getMinutes()/60,f[p]=Math.round(r.getTime()/36e5),q=a(f[p],q),g[p]=l[parseInt(b.severity)],h[p]=n[parseInt(b.road_state)],i[p]=parseInt(b.speed_limit),j[p]=m[parseInt(b.weather)],"undefined"!=typeof d[p]&&"undefined"!=typeof e[p]&&"undefined"!=typeof g[p]||console.error("error id data")}),visualize({pts:c,days:d,hours:e,sev:g,state:h,speed_limit:i,date:f,dmm:q,num:p.length,daysEnum:k,sevEnum:l,stateEnum:n,weather:j,weatherEnum:m})})}}function init(){initMap();var a=new DataLoader;a.loadPosData("data/accidents.csv")}function visualize(a){function b(){$(".pc_chart_div").slideToggle();var a=WGL.getDimension("pc_chart"),b=function(){WGL.getManager().updateMapSize(),WGL.mcontroller.resize(),WGL.mcontroller.zoommove(map.getZoom(),getTopLeftTC()),WGL.render(),map.updateSize()};a.visible?(a.setVisible(!1),$("#map").animate({"margin-bottom":"1.5em"},{done:b}),$("#pc").animate({height:"1.5em"},{done:b}),$("#butPC").removeClass("fa-chevron-down"),$("#butPC").addClass("fa-chevron-up"),setTimeout(function(){map.updateSize()},200)):(a.setVisible(!0),$("#map").animate({"margin-bottom":"18.5em"},{done:b}),$("#pc").animate({height:"18.5em"},{done:b}),$("#butPC").removeClass("fa-chevron-up"),$("#butPC").addClass("fa-chevron-down"),setTimeout(function(){map.updateSize()},200))}WGL.init(a.num,"../webglayer/","map","OpenLayers_Map_2_OpenLayers_Container"),window.onresize=function(){WGL.resize()},map.events.register("move",map,onMove);var c=WGL.addHeatMapDimension(a.pts,"heatmap");c.radiusFunction=function(a,b){var c=a/2e4*Math.pow(2,b);map.getGeodesicPixelSize();return c},c.setRadius(100);var d=WGL.addMapDimension(a.pts,"themap");d.setVisible(!1),WGL.addPolyBrushFilter("themap","polybrush"),WGL.addExtentFilter();var e=[],f={data:a.days,domain:a.daysEnum,name:"days",type:"ordinal",label:"day of the week"},g=new WGL.ChartDiv("charts","ch1","Day of the week");g.setDim(WGL.addOrdinalHistDimension(f)),WGL.addLinearFilter(f,7,"daysF"),e.days=new WGL.ui.StackedBarChart(f,"ch1","day of the week","daysF"),g.change();var h={data:a.hours,min:0,max:24,num_bins:120,name:"hours",type:"linear",label:"hour of the day"},i=new WGL.ChartDiv("charts","ch2","Hour of the day");i.setDim(WGL.addLinearHistDimension(h)),WGL.addLinearFilter(h,240,"hoursF"),e.hours=new WGL.ui.StackedBarChart(h,"ch2","hour of the day","hoursF"),i.change();var j={data:a.sev,domain:a.sevEnum,name:"sev",type:"ordinal",label:"accident severity"},k=new WGL.ChartDiv("charts","ch3","Accident severity");k.setDim(WGL.addOrdinalHistDimension(j)),WGL.addLinearFilter(j,4,"sevF"),e.sev=new WGL.ui.StackedBarChart(j,"ch3","accident severity","sevF"),k.change();var l={data:a.speed_limit,min:0,max:130,num_bins:13,name:"speedlimit",type:"linear",label:"speed limit"},m=new WGL.ChartDiv("charts","ch4","Speed Limit");m.setDim(WGL.addLinearHistDimension(l)),WGL.addLinearFilter(l,13,"slF"),e.speedlimit=new WGL.ui.StackedBarChart(l,"ch4","Speed limit","slF"),m.change();var n={data:a.date,min:a.dmm.min,max:a.dmm.max,num_bins:100,name:"date",type:"linear"},o=new WGL.ChartDiv("charts","ch5","Date");o.setDim(WGL.addLinearHistDimension(n)),WGL.addLinearFilter(n,n.num_bins,"dateF"),e.date=new WGL.ui.StackedBarChart(n,"ch5","Date (month - year)","dateF"),e.date.xformat=function(a){var b=new Date(1e3*a*60*60);return b.getMonth()+" - "+b.getFullYear()},o.change();var p={data:a.state,domain:a.stateEnum,name:"state",type:"ordinal",label:"State of the road"},q=new WGL.ChartDiv("charts","ch6","State of the road");q.setDim(WGL.addOrdinalHistDimension(p)),WGL.addLinearFilter(p,6,"stateF"),e.state=new WGL.ui.StackedBarChart(p,"ch6","State of the road","stateF"),q.change();var r={data:a.weather,domain:a.weatherEnum,name:"weather",type:"ordinal",label:"Weather"},s=new WGL.ChartDiv("charts","ch7","Weather");s.setDim(WGL.addOrdinalHistDimension(r)),WGL.addLinearFilter(r,8,"weatherF"),e.weather=new WGL.ui.StackedBarChart(r,"ch7","Weather","weatherF"),s.change();var t=new WGL.ChartDiv("charts","chm","Heatmap controls");t.change(),addHeatMapControl(c,"chm");for(var u in e)e[u].y_label="number of accidents",e[u].setYFormat(function(a){return d3.round(a)});var v=[];v[0]=h,v[1]=f,v[2]=p,v[3]=l,v[4]=j,v[5]=r;var w=WGL.addParallelCoordinates("pc_chart",v);WGL.addMultiDim(v),WGL.addCharts(e),WGL.initFilters(),$("#slider_pc").on("input",function(){w.reRender(this.value)}),$("#reset").on("click",function(){WGL.resetFilters();var a=new OpenLayers.LonLat(-1.9,52.5).transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"));map.setCenter(a),map.zoomTo(11)}),$("#pc_header").click(function(){b()}),$("#points_visible").click(function(){var a=WGL.getDimension(this.name);a.setVisible(this.checked),WGL.render()}),$("#heatmap_visible").click(function(){var a=WGL.getDimension(this.name);a.setVisible(this.checked),WGL.render()}),$("#schools_visible").click(function(){map.getLayersByName("Points")[0].setVisibility(this.checked)}),$("#road_wms_visible").click(function(){this.checked?(map.setBaseLayer(map.getLayersByName("roads")[0]),$("#light_visible").prop("checked",!1)):map.setBaseLayer(map.getLayersByName("osm")[0])}),$("#light_visible").click(function(){this.checked?(map.setBaseLayer(map.getLayersByName("osm_light")[0]),$("#road_wms_visible").prop("checked",!1)):map.setBaseLayer(map.getLayersByName("osm")[0])}),$("#cross").click(function(){var a=function(){WGL.getManager().updateMapSize(),WGL.mcontroller.resize(),WGL.mcontroller.zoommove(map.getZoom(),getTopLeftTC()),WGL.render(),map.updateSize()};$("#right").toggle(),$(this).toggleClass("active"),$("#sipka").toggleClass("fa-chevron-right"),$("#sipka").toggleClass("fa-chevron-left"),$("#map").toggleClass("fullscrean"),$("#pc").toggleClass("pc_chart_big"),a(),$("#info").hide()}),WGL.mcontroller.zoommove(map.getZoom(),getTopLeftTC()),b()}function getTopLeftTC(){var a=new OpenLayers.LonLat(-180,90).transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913")),b=Math.pow(2,map.getZoom());return tlpixel=map.getViewPortPxFromLonLat(a),res={x:-tlpixel.x/b,y:-tlpixel.y/b},res}function onMove(){WGL.mcontroller.zoommove(map.getZoom(),getTopLeftTC(),WGL.filterByExt)}function updateLabel(a){console.log(a)}function addHeatMapControl(a,b){$("#"+b).append("<div id="+b+"left style='top:0em; left:0em; width:40%'></div><div id="+b+"right style='top:0em; right:0em; width:60%; height:10em; position:absolute'></div>");var c=$("#"+b+"right");c.append("<div style='margin:0.5em'><text>Radius: </text><text id='radius_label'></text><input style='width: 50%; right:1em; position:absolute' type ='range' max='300' min='1'step='1' name='points' id='slider_radius' value='100'></input> </div>"),c.append("<div style='margin:0.5em'><text>Auto-adjust colour scale:</text><input style='width: 20%; right:0em; position:absolute' type ='checkbox' default='true' id='max_checked' checked='true' ></input> </div>"),c.append("<div style='margin:0.5em'><text>Manually adjust colour scale:</text><br/><input style='width: 50%; right:1em; position:absolute' type ='range' max='300' min='1'step='1' name='points' id='hm_max' value='10' disabled></input> </div>"),WGL.addColorFilter(a.id,"colorbrush");var d=new WGL.ui.HeatMapLegend(b+"left","colorbrush");a.addLegend(d),WGL.addLegend(d),$("#slider_radius").on("input",function(){a.setRadius(this.value),$("#radius_label").html(this.value+"m "),WGL.render()}),$("#hm_max").on("input",function(){a.maxVal=this.value,WGL.render(),d.updateMaxAll(this.value)}),$("#max_checked").on("click",function(b,c){a.lockScale=!this.checked,document.getElementById("hm_max").disabled=this.checked,WGL.render()})}function trianglesToArray(a){var b=[];for(var c in a)for(var d in a[c].points_)b.push(a[c].points_[d].x),b.push(a[c].points_[d].y);return b}function update(){controls.modify.mode=OpenLayers.Control.ModifyFeature.RESHAPE;var a=document.getElementById("dragEvent").checked;a&&(controls.modify.deactivate(),controls.drag.activate()),controls.modify.createVertices=document.getElementById("createVertices").checked;var b=parseInt(document.getElementById("sides").value);b=Math.max(3,isNaN(b)?0:b),controls.regular.handler.sides=b;var c=document.getElementById("irregular").checked;controls.regular.handler.irregular=c}function toggleControl(a){for(key in controls){var b=controls[key];a.value==key&&a.checked?b.activate():b.deactivate()}}function transform(a,b){var c=getTopLeftTC(),d=new OpenLayers.LonLat(b,a);d.transform(wgs,map.projection);var e=map.getViewPortPxFromLonLat(d),f=toLevel0(e,c,map.getZoom());return f}function toLevel0(a,b,c){return ts=256,scale=Math.pow(2,c),a.x=a.x/scale+b.x,a.y=a.y/scale+b.y,a}var wgs=new OpenLayers.Projection("EPSG:4326"),merc=new OpenLayers.Projection("EPSG:900913");initMap=function(){function a(a){if("sketchcomplete"!=a.type){if(a.feature.geometry.getVertices().length>=3){var d=a.feature.geometry.getVertices();n=a.feature.id;for(var e=[],f=0;f<d.length;f++){var g=new OpenLayers.LonLat(d[f].x,d[f].y);g.transform(c,b);var h=transform(g.lat,g.lon);e.push(h)}try{var i=new poly2tri.SweepContext(e);i.triangulate(),o[n]=trianglesToArray(i.getTriangles()),o.length=Object.keys(o).length,WGL.filterDim("themap","polybrush",o)}catch(a){console.log(a)}}}else o[a.feature.id]=o[n],delete o[n]}$("#info").toggle();var b=new OpenLayers.Projection("EPSG:4326"),c=new OpenLayers.Projection("EPSG:900913"),d={units:"m",projection:"EPSG:900913",zoomMethod:null};map=new OpenLayers.Map("map",d),map.events.register("updatesize",map,function(){WGL.getManager().updateMapSize(),WGL.mcontroller.resize(),WGL.mcontroller.zoommove(map.zoom,getTopLeftTC())});var e=new OpenLayers.Layer.OSM("osm","http://${s}.basemaps.cartocdn.com/dark_all/${z}/${x}/${y}.png",{}),f=new OpenLayers.Layer.OSM("osm_light","http://${s}.basemaps.cartocdn.com/light_all/${z}/${x}/${y}.png",{}),g={layers:"AUTOSWEG,WEGGESCH,WEGEEN,ROT,SPECSIT,VERKPLEIN,OPAFOGKR,OPAFGGKR,PLLWEG,VENTWEG,INUITP,INUITD,WANDFIETS,TRAMWEG,DIENSTWEG,AARDEWEG,VEER,LABELS"},h=new OpenLayers.Layer.WMS("roads","http://geoservices.informatievlaanderen.be/raadpleegdiensten/Wegenregister/wms",g);h.projection=new OpenLayers.Projection("EPSG:3857");var i=new OpenLayers.Layer.Vector("Points",{styleMap:new OpenLayers.Style({pointRadius:14,fillColor:"#666666",externalGraphic:"http://otn-production.intrasoft-intl.com/maps/symbols/!school.svg"}),minScale:1e5});i.setVisibility(!1),map.addLayer(i),$.ajax({dataType:"json",url:"./data/schools.json",success:function(a){var b=new OpenLayers.Format.GeoJSON;i.addFeatures(b.read(a))}}),map.addLayer(e),map.addLayer(f),map.addLayer(h);var j=OpenLayers.Util.getParameters(window.location.href).renderer;j=j?[j]:OpenLayers.Layer.Vector.prototype.renderers;var k=(new OpenLayers.Style({fillColor:"green",pointRadius:10,externalGraphic:"${thumbnail}"}),new OpenLayers.Style({pointRadius:20})),l=new OpenLayers.Style({pointRadius:7,fillColor:"white",fillOpacity:.2,strokeColor:"#ff8c00",strokeOpacity:1,strokeWidth:6,"z-index":1e8}),m=new OpenLayers.StyleMap({default:l,select:k,temporary:l});vectors=new OpenLayers.Layer.Vector("Vector Layer",{renderers:j,styleMap:m}),map.addLayers([vectors]);var n,o=(map.getControlsByClass("OpenLayers.Control.Navigation")[0],[]);vectors.events.on({beforefeaturemodified:a,featuremodified:a,vertexdragged:a,afterfeaturemodified:a,vertexmodified:a,sketchmodified:a,sketchstarted:a,sketchcomplete:a});var p=new OpenLayers.Control.ModifyFeature(vectors),q=(p.handlers.drag.move,new OpenLayers.Control.DragFeature(vectors));q.onDrag=function(a,b){console.log(b)};var r=new OpenLayers.Control.SelectFeature(vectors,{displayClass:"olControlDelete",eventListeners:{featurehighlighted:function(a){var b=a.feature;console.log("deleteing "+b.id),delete o[b.id],vectors.removeFeatures([b]);var c=0;for(var d in o)"undefined"!=typeof o[d]&&c++;o.length=c,WGL.filterDim("themap","polybrush",o)}}});controls={polygon:new OpenLayers.Control.DrawFeature(vectors,OpenLayers.Handler.Polygon),modify:p,drag:q,remove:r};for(var s in controls)map.addControl(controls[s]);var t=new OpenLayers.LonLat(4.241,51.036).transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"));map.setCenter(t),map.zoomTo(9)};
