<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Traffic volume visualization</title>

<link rel="stylesheet" type="text/css" href="otn_style.css">

<script src="javascripts/ol/lib/OpenLayers.js"></script>
<script src="javascripts/jquery-1.9.1.min.js"></script>
<script src="javascripts/jquery-ui.js"></script>
<link rel="stylesheet" href="stylesheets/jquery-ui.css">
<script src="javascripts/poly2tri.js"></script>
<script src="javascripts/d3.js"></script>


<script src="map.js"></script>
<script src="OtnDataLoader.js"></script>

<script src="vl/js/GLUtils.js"></script>

<script src="vl/js/Dimension.js"></script>
<script src="vl/js/Manager.js"></script>
<script src="vl/js/OneDDimension.js"></script>
<script src="vl/js/InterpolationDimension.js"></script>
<script src="vl/js/InterpolationRenderer.js"></script>
<script src="vl/js/MapDimension.js"></script>
<script src="vl/js/MapLineDimension.js"></script>
<script src="vl/js/HistogramDimension.js"></script>
<script src="vl/js/Dimension.js"></script>
<script src="vl/js/Utils.js"></script>
<script src="vl/js/MapController.js"></script>
<script src="vl/js/StackedBarChart.js"></script>
<script src="vl/js/FloatRasterReader.js"></script>
<script src="vl/js/d3.svg.multibrush.js"></script>
<script src="vl/js/Filter.js"></script>
<script src="vl/js/HistFilterRender.js"></script>



<script type="text/javascript">
  
	var map, vectors, controls;
	var at1 = "data/2009_att.json";
	var li1 = "data/2009_links.json";
	var at2 = "data/2020_att.json";
	var li2 = "data/2020_links.json";
	

		function init() {	
					
		GLU.loadShaders();
		metadata = [];
		initMap();
		
		utils = new Utils();
		//r_count = 1 * Math.pow(10, 5);
		manager = new Manager("test", "map");
		mcontroller = new MapController(manager);

		canvas.setAttribute("width", div.offsetWidth);
		canvas.setAttribute("height", div.offsetHeight);
		manager.width=div.offsetWidth;
		manager.height=div.offsetHeight;
		

		wgs = new OpenLayers.Projection("EPSG:4326"); // Transform from WGS 1984
		merc = new OpenLayers.Projection("EPSG:900913");
		
		/*Importat global variables*/
		tlwgs = (new OpenLayers.LonLat(-180, 90)).transform(wgs, merc);	
		tl = GLU.getTopLeftTC();
		
		
		/*Configure speed dimension*/
		metadata[0] = {max : 1, num_bins : 30, name: "attr100"};					
		metadata.max_bins =metadata[0].num_bins;
		
		charts = [];
		charts[0] = new StackedBarChart(metadata[0].max, 0, "speed_chart","traffic intensity");
	
		
		
		var data = new OtnDataLoader();
		//var rastersize = data.loadPosData("data/queryid1.json","data/queryid2.json");
		//var rastersize = data.loadPosData("rest/query?id=1","rest/query?id=2");
		var rastersize = data.loadPosData(li1,at1,li2,at2);
		//var rastersize = data.loadPosData("data/queryid1.json","data/queryid2.json");
		//var rastersize = data.loadPosData("data/pos.json");
		//data.loadObsData("data/obs.json")
		
		//var rastersize = data.loadTextData("data/"+datafile);
		
		

	}

	function render(){
		 if (manager.year == 0){
			 allDataFilter09.render();
			 manager.filterTexture = 	allDataFilter09.filterTexture;
		 } else {
			 allDataFilter20.render();
			 manager.filterTexture = 	allDataFilter20.filterTexture;
		 }
		
		 dimLineMap.render(manager.num_rec);	
		 histDim.render(manager.num_rec);
		 var readout = histDim.readPixels();
		 if (typeof readout != 'undefined') {
				for ( var i in charts) {
					charts[i].update(readout[i]);
				}
		 }
	}
	function visualize(data){	
		manager.year=0;
		manager.time=0;
		$("#speed_chart").text("");
		
		 $(function() {
			 $( "#slider" ).slider({min:0, max:data.y2009.attributes.length-1});
			 });
		 $( "#slider" ).on( "slide", function( event, ui ) {			 			
			 dimLineMap.buf_id = ui.value;
			 manager.time = ui.value;
			 metadata[0].name = "attr1"+manager.year+manager.time;
			 render();
			 });
		 
		// A slider with a step of 1
		 $("#slider")
		 .each(function() {
		     // Add labels to slider whose values 
		     // are specified by min, max
		     // Get the options for this slider (specified above)
		     var opt = $(this).data().uiSlider.options;
		     // Get the number of possible values
		     var vals = opt.max - opt.min;
		     // Position the labels
		     var labels= {0:"7:00", 1:"8:00", 2:"12:00", 3:"15:00", 4:"16:00", 5:"17:00"};
		     for (var i = 0; i <= vals; i++) {
		         // Create a new element and position it with percentages
		         var el = $('<label>' + labels[i] + '</label>').css('left', (i/vals*100) + '%');

		         // Add the element inside #slider
		        $("#slider").append(el);

		     }

		 });

		
		 $(function() {
			 $( "#slider_y" ).slider({min:0, max:1});
			 });
		 $( "#slider_y" ).on( "slide", function( event, ui ) {			 			
			 dimLineMap.y_id = ui.value;
			 manager.year = ui.value;
			 metadata[0].name = "attr1"+manager.year+manager.time;
			 manager.num_rec = manager["num_rec"+ui.value];		
			 manager.index = "index"+ui.value;
			 render();
			 });
		 
		 
		
		manager.num_rec0 = data.y2009.num_rec;	
		/**init*/
		manager.num_rec = data.y2009.num_rec;
		
		manager.index = "index0";
		manager.addDataBuffer(data.y2009.points, 2, 'wPoint0');	
		manager.addDataBuffer(data.y2009.index, 2, 'index0');
		manager.addDataBuffer(data.y2009.indexLine, 2, 'index0Line');	
		
		
		for (var i = 0; i < data.y2009.attributes.length; i++){
			manager.addDataBuffer(data.y2009.attributes[i], 1, "attr0"+i);
			manager.addDataBuffer(data.y2009.attributes1[i], 1, "attr10"+i);
		}
		
		manager.num_rec1 = data.y2020.num_rec;	
		manager.addDataBuffer(data.y2020.points, 2, 'wPoint1');	
		manager.addDataBuffer(data.y2020.index, 2, 'index1');	
		manager.addDataBuffer(data.y2020.indexLine, 2, 'index1Line');	
		
		
		for (var i = 0; i < data.y2020.attributes.length; i++){
			manager.addDataBuffer(data.y2020.attributes[i], 1, "attr1"+i);
			manager.addDataBuffer(data.y2020.attributes1[i], 1, "attr11"+i);
		}
		/*init first attribute buffer*/			
										
		/* init index buffer*/
		//manager.addDataBuffer(data.index, 2, 'index');
		manager.r_size_2009 = data.y2009.raster_size;
		manager.r_size_2020 = data.y2020.raster_size;
		initGLDimensions();
		
		data = null;
		
		//util.createFilteringData(generateOneTriangle());
		
		map.events.register("move", map, onMove);
		map.events.register("zoomstart", map, onZoom);	
	}
	
	
	function initGLDimensions(){
		manager.update();
		mcontroller = new MapController(manager);

		canvas.setAttribute("width", div.offsetWidth);
		canvas.setAttribute("height", div.offsetHeight);
		
		dimLineMap = new MapLineDimension(manager);
		dimLineMap.name = "map";
		dimLineMap.setProgram('mapline_vShader', 'mapline_fShader', 'map');
		dimLineMap.buf_id = "1";
		dimLineMap.y_id = "0";			
		
	 	histDim = new HistogramDimension(manager);
	 	allDataFilter09 = new Filter(manager.r_size_2009 , manager);
	 	allDataFilter20 = new Filter(manager.r_size_2020 , manager);	 
	 	
		histFilterRender = new HistFilterRender(manager);	
		
		mcontroller.resize(div.offsetWidth, div.offsetHeight);
		mcontroller.zoommove(map.zoom, tl, render);

	
	}
	
	onMove = function() {
		mcontroller.zoommove(map.getZoom(), GLU.getTopLeftTC(), render);
	}
	
	onZoom = function() {
		mcontroller.zoommove(map.getZoom(), GLU.getTopLeftTC(), render);
	}
	
		

</script>

</head>
<body onload="init()">

	<div id="map">
			<canvas id="test">Your browser does not support HTML5</canvas>
	</div>
	<div id="right">
		
		
			<div style="margin:1em">Time:<div style="margin:1em" id = "slider"> </div></div>
			
				
			<div style="margin:1em; padding-top:1em">Year (2009 - 2020)	 <div style="margin:1em; width: 3em""  id = "slider_y"> </div></div>
			
			<div id = "speed_chart"></div>
	 		<div id = "hour_chart"></div> 
	 		
	 				<div id = "about">
	 		This demo shows the traffic volumes for the city of Antwerp based on the road network from 2009 and 2020.
	 		The data are provided by <a href="http://www.opentransportnet.eu/">OpenTransportNet</a> project. 
	 		Make a selection in the histogram to highlight the specific parts of the road network.
	 		The visualization is based on  <a href="http://jezekjan.github.io/webglayer/">WebGLayer</a> library.
	 	    </div> 		 	
	 		
	</div>
	<div id="controls">
		
		
		
	</div>

</body>
</html>
